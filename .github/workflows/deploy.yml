name: build and deploy

on:
    push:
      branches:
        - main
      paths-ignore:
        - '**.md'
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
                
            - name: Install Zig toolchain
              uses: korandoru/setup-zig@v1
              with:
                zig-version: 0.10.0

            - name: Install Cargo Lambda
              uses: jaxxstorm/action-install-gh-release@v1.9.0
              with:
                repo: cargo-lambda/cargo-lambda
                tag: v0.14.0 # Remove this if you want to grab always the latest version
                platform: linux # Other valid options: 'windows' or 'darwin'
                arch: x86_64 # Other valid options for linux: 'aarch64'
                # Add your build steps below

            - name: Checkout Repository
              uses: actions/checkout@v2
  
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Build
              run: |
                cargo lambda build --release

            - name: Test
              run: |
                cargo test

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
          
            - name: Terraform
              run: |
                cd infrastructure
                terraform init
                terraform refresh
                terraform plan
                terraform apply --autoapprove

            - name: Deploy
              run: |
                cargo lambda deploy --iam-role ${{ secrets.AWS_LAMBDA_ARN }} rust-lambda
